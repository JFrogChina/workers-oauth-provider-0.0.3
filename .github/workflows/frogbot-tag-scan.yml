# 文件路径：.github/workflows/frogbot-manual-scan.yml
name: "Frogbot Manual Scan (Branch or Tag)"

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or Tag to scan (e.g., [branch]:release/v0.0.4 or [tag]:v0.0.3)'
        required: true
        default: 'main'

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  frogbot-scan:
    runs-on: ubuntu-latest

    steps:
      # 1. 完整拉取包含所有分支与 Tag
      - name: Checkout code at ${{ github.event.inputs.ref }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}
          fetch-depth: 0
          fetch-tags: true

      # 2. Debug：确认当前运行的 ref
      - name: Debug current ref
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Requested ref: ${{ github.event.inputs.ref }}"
          echo "Resolved ref: ${{ github.ref }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "Tags pointing at HEAD: $(git tag --points-at HEAD || true)"

      # 3. 安装 pnpm（如有需要，可删掉此步）
      - name: Set up pnpm
        run: |
          export SHELL=/bin/bash
          curl -fsSL https://get.pnpm.io/install.sh | sh -
          echo "PNPM_HOME=$HOME/.local/share/pnpm" >> $GITHUB_ENV
          echo "PATH=$HOME/.local/share/pnpm:$PATH" >> $GITHUB_ENV

      # 4. 执行 Frogbot 扫描
      - name: Run Frogbot security scan
        uses: jfrog/frogbot@v2
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
          JF_GIT_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 这里的基线也使用同一个输入的 ref，Frogbot 会根据它决定差异
          JF_GIT_BASE_BRANCH: ${{ github.event.inputs.ref }}
