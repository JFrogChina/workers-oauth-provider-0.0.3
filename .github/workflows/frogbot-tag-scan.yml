# .github/workflows/frogbot-manual-scan.yml
name: "Frogbot Manual Scan (Branch or Tag)"

on:
  workflow_dispatch:
    inputs:
      ref_type:
        description: 'Choose scan type'
        required: true
        default: 'branch'
        type: choice
        options:
          - branch
          - tag
      ref_name:
        description: 'Name of branch or tag to scan (e.g., main or v0.0.3)'
        required: true
        default: 'main'

permissions:
  pull-requests: write
  contents: write
  security-events: write

jobs:
  frogbot-scan:
    runs-on: ubuntu-latest

    env:
      REF_TYPE: ${{ github.event.inputs.ref_type }}
      REF_NAME: ${{ github.event.inputs.ref_name }}
      # 用于 checkout
      FULL_REF: ${{ github.event.inputs.ref_type == 'tag' && format('refs/tags/{0}', github.event.inputs.ref_name) || format('refs/heads/{0}', github.event.inputs.ref_name) }}

    steps:
      - name: Checkout code at ${{ env.REF_TYPE }} / ${{ env.REF_NAME }}
        uses: actions/checkout@v4
        with:
          ref: ${{ env.FULL_REF }}
          fetch-depth: 0
          fetch-tags: true

      - name: Debug current ref
        run: |
          echo "Requested type       : ${{ env.REF_TYPE }}"
          echo "Requested name       : ${{ env.REF_NAME }}"
          echo "Using Git ref        : ${{ env.FULL_REF }}"
          echo "Resolved HEAD commit : $(git rev-parse --short HEAD)"
          echo "Tags at this commit  : $(git tag --points-at HEAD || echo none)"

      - name: Push branch to remote (if needed)
        if: ${{ env.REF_TYPE == 'branch' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # 将当前 HEAD 推到指定分支（创建或更新）
          git push origin "HEAD:${{ env.REF_NAME }}" --force-with-lease

      - name: Set up pnpm
        run: |
          export SHELL=/bin/bash
          curl -fsSL https://get.pnpm.io/install.sh | sh -
          echo "PNPM_HOME=$HOME/.local/share/pnpm" >> $GITHUB_ENV
          echo "PATH=$HOME/.local/share/pnpm:$PATH" >> $GITHUB_ENV

      - name: Run Frogbot security scan
        uses: jfrog/frogbot@v2
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
          JF_GIT_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 直接传分支或 tag 名称，不要带 refs/ 前缀
          JF_GIT_BASE_BRANCH: ${{ github.REF_NAME }}
