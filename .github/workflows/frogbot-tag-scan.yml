# .github/workflows/frogbot-manual-scan.yml
name: "Frogbot Manual Scan (Branch or Tag)"

on:
  workflow_dispatch:
    inputs:
      ref_type:
        description: 'Choose scan type'
        required: true
        default: 'branch'
        type: choice
        options:
          - branch
          - tag
      ref_name:
        description: 'Name of branch or tag to scan (e.g., main or v0.0.3)'
        required: true
        default: 'main'

permissions:
  pull-requests: write
  contents: write
  security-events: write

jobs:
  frogbot-scan:
    runs-on: ubuntu-latest

    env:
      REF_TYPE: ${{ github.event.inputs.ref_type }}
      REF_NAME: ${{ github.event.inputs.ref_name }}
      FULL_REF: ${{ github.event.inputs.ref_type == 'tag' && format('refs/tags/{0}', github.event.inputs.ref_name) || format('refs/heads/{0}', github.event.inputs.ref_name) }}

    steps:
      - name: Checkout code at ${{ env.REF_TYPE }} / ${{ env.REF_NAME }}
        uses: actions/checkout@v4
        with:
          ref: ${{ env.FULL_REF }}
          fetch-depth: 0
          fetch-tags: true

      - name: Debug current ref
        run: |
          echo "Requested type       : ${{ env.REF_TYPE }}"
          echo "Requested name       : ${{ env.REF_NAME }}"
          echo "Using Git ref        : ${{ env.FULL_REF }}"
          echo "Resolved HEAD commit : $(git rev-parse --short HEAD)"
          echo "Tags at this commit  : $(git tag --points-at HEAD || echo none)"

      - name: Determine scan branch
        id: scan_branch
        run: |
          if [[ "${REF_TYPE}" == "tag" ]]; then
            echo "scan_branch=frogbot-${REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            echo "scan_branch=${REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare and push scan branch (from tag)
        if: ${{ env.REF_TYPE == 'tag' }}
        run: |
          set -euxo pipefail
          git fetch origin --prune --tags
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # 从 tag 衍生出 frogbot-<tag> 分支并 push
          git switch -c "${{ steps.scan_branch.outputs.scan_branch }}"
          git push origin "HEAD:${{ steps.scan_branch.outputs.scan_branch }}" --force-with-lease

      - name: Set up pnpm
        run: |
          export SHELL=/bin/bash
          curl -fsSL https://get.pnpm.io/install.sh | sh -
          echo "PNPM_HOME=$HOME/.local/share/pnpm" >> $GITHUB_ENV
          echo "PATH=$HOME/.local/share/pnpm:$PATH" >> $GITHUB_ENV

      - name: Run Frogbot security scan
        uses: jfrog/frogbot@v2
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
          JF_GIT_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 用实际用于扫描的 branch 名（tag 情况是 frogbot-<tag>）
          JF_GIT_BASE_BRANCH: ${{ steps.scan_branch.outputs.scan_branch }}

      - name: Cleanup remote scan branch
        if: ${{ env.REF_TYPE == 'tag' }}
        run: |
          set -euxo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          BR="frogbot-${REF_NAME}"
          echo "Deleting remote branch ${BR}"
          git push origin --delete "${BR}" || echo "Remote branch ${BR} already removed"
